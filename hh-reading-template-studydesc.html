<!--bower component-->
<script src="../ag-grid-enterprise/dist/ag-grid-enterprise.js"></script>
<link rel="import" href="../ag-grid-polymer/ag-grid-polymer.html">

<!--develop-->
<!--<script src="../bower_components/ag-grid-enterprise/dist/ag-grid-enterprise.js"></script>-->
<!--<link rel="import" href="../bower_components/ag-grid-polymer/ag-grid-polymer.html">-->
<script src="licenseKey.js"></script>
<dom-module id="hh-reading-template-studydesc">
    <template>
        <!--bower component-->
        <link rel="stylesheet" href="../ag-grid/dist/styles/ag-grid.css">
        <link rel="stylesheet" href="../ag-grid/dist/styles/ag-theme-balham-dark.css">

        <!--develop-->
        <!--<link rel="stylesheet" href="../bower_components/ag-grid/dist/styles/ag-grid.css">-->
        <!--<link rel="stylesheet" href="../bower_components/ag-grid/dist/styles/ag-theme-balham-dark.css">-->
        <style>
            :host {
                height: 100%;
                width: 100%;
            }
            .container {
                height: 100%;
                width: 100%;
            }

            ag-grid-polymer {
                width: 83%;
                height: 80%;
                margin-top: 5%;
            }

            .class-input{
                height: calc(100% - 45px);
                width: 100%;
            }

            .class-studyDescription{
                height: 40px;
                width: 70%;
                margin-top: 1%;
                color: #aaaaaa;
                background-color: #2c333f;
            }
            .class-studyDescription-list{
                height: calc(100% - 40px);
                margin-top: 1%;
                width: 60%;
                color: #aaaaaa;
                background-color: #2c333f;
            }

            .class-shortcut{
                height: 128px;
                width: 100%;
                color: #aaaaaa;
                background-color: #333a47;
            }

            .class-sd-btn{
                height: 45px;
                width: 100%;
                color: #aaaaaa;
                background-color: #252934;
                text-align: right;
                border-top: 5px solid black;
                /*padding-right: 15px;*/
            }

            .btn {
                width: 100px;
                height: 30px;
                border: 0;
                font-size: 10pt;
                color: #fff;
                cursor: pointer;
                border-radius: 2px;
                margin: 5px;
            }

            #prevBtn {
                background: #ff646b;
            }
            #nextBtn {
                background: #0087cb;
            }
            #clearBtn {
                background: #4c5667;
            }

            .class-search{
                width: 70%;
                margin-left: 10%;
            }
            .class-wrap{
                display: flex;
                height: calc(100% - 128px);
                width: 100%;
                background-color: #2c333f;
            }

            .checkBox-style{
                font-size: 15px;
                color: #aaaaaa;
                --paper-checkbox-checked-color: #0087cb;
                --paper-checkbox-label-color: #aaaaaa;
                --paper-checkbox-unchecked-color: #4c5667;
                padding: 3px;
            }

            paper-input {
                --paper-input-container-focus-color: #0087cb;
                --paper-input-container-input-color: #aaaaaa;
                --paper-input-container-input-text-align: initial;
                --paper-input-container-label-color: #aaaaaa;
            }

        </style>
        <div class="container">
            <div class="class-input">
                <div class="class-wrap">
                    <div class="class-studyDescription">
                        <paper-input id="inputStudyDesc" label="INPUT STUDY DESCRIPTION" class="class-search" style="margin-left: 20%" char-counter maxlength="50"></paper-input>
                    </div>
                    <div class="class-studyDescription-list">
                        <ag-grid-polymer
                                class="ag-theme-balham-dark"
                                rowData="{{rowData}}"
                                columnDefs="{{columnDefs}}"
                                gridOptions="{{gridOptions}}"
                        ></ag-grid-polymer>
                    </div>
                </div>
                <div class="class-shortcut">
                    <paper-input class="class-search" id="inputShortcut" label="INPUT REPORT-TEMPLATE SHORTCUT" char-counter  maxlength="30"></paper-input>
                </div>
            </div>
            <div class="class-sd-btn">
                <button id="clearBtn" class="btn">Clear</button>
                <button id="prevBtn" class="btn">Prev</button>
                <button id="nextBtn" class="btn">Next</button>
            </div>
        </div>
    </template>
    <script>
        (function () {
            let _this;
            let g_humiicDesc = new Array();
            let g_resultDesc = new Array();

            class HhReadingTemplateStudyDesc extends Polymer.Element {
                static get is() {
                    return 'hh-reading-template-studydesc';
                }

                constructor() {
                    super();
                    _this = this;

                    this.gridOptions = {
                        defaultColDef: {
                            suppressMenu: true // 메뉴 막기
                        },
                        // columnDefs: _this.createColumnDefs(),
                        enableSorting: true,
                        enableColResize: true,
                        rowSelection: "single",
                        overlayNoRowsTemplate: '<span class="ag-overlay-no-rows-center">No records Found</span>',
                        toolPanelSuppressSideButtons: true,
                        toolPanelSuppressRowGroups: true,
                        toolPanelSuppressValues: true,
                        toolPanelSuppressColumnSelectAll: true,
                        toolPanelSuppressColumnExpandAll: true,
                        toolPanelSuppressColumnFilter: true,
                        toolPanelSuppressPivots: false,
                        toolPanelSuppressPivotMode: true
                    };

                    this.columnDefs = [
                        // {headerName: "병명코드", field: "hCode", width: 300},
                        {headerName: "Study Description", field: "studyDescription", width: 580},
                        // {headerName: "Modality", field: "modality", width: 200}
                    ];
                    this.rowData = [
                    ];

                    this.gridOptions.onGridReady = (params) => {
                        // params.api.sizeColumnsToFit();
                    }

                    this.gridOptions.onRowDoubleClicked = (event) => {
                        let param = new Object();
                        let detail = new Object();
                        detail.studyDesc = event.data.studyDescription;
                        g_resultDesc =event.data.studyDescription;
                        param.detail = detail;
                        _this.dispatchEvent(new CustomEvent('activeTab', param));
                    }
                }

                ready() {
                    super.ready();
                    // this.readTextFile("../humiic_studyDesc_json", function(desc){
                    //     if(desc){
                    //         g_humiicDesc  = JSON.parse(desc);
                    //     }
                    // });
                    this.readTextFile();

                    this.$.prevBtn.addEventListener('click', function () {
                        _this.dispatchEvent(new CustomEvent('prevTabEvent'));
                    });

                    this.$.inputStudyDesc.addEventListener('keyup', function (e) {
                        _this.searchStudyDesc();
                    });

                    this.$.inputShortcut.addEventListener('focused-changed', function (e) {
                        let param = new Object();
                        let detail = new Object();
                        detail.shortcut = _this.$.inputShortcut.value;
                        if(g_resultDesc){
                            detail.studyDesc = g_resultDesc;
                        }
                        param.detail = detail;
                        if(_this.$.inputShortcut.value) {
                            _this.dispatchEvent(new CustomEvent('activeTab', param));
                        }
                    });

                    this.$.nextBtn.addEventListener('click', function () {
                        let param = new Object();
                        let detail = new Object();
                        let studyDesc = new Object();
                        let desc = _this.$.inputStudyDesc.value;
                        let shortcut = _this.$.inputShortcut.value;
                        studyDesc.desc = desc;
                        studyDesc.shortcut = shortcut;
                        detail.studyDesc = studyDesc;
                        param.detail = detail;
                        _this.dispatchEvent(new CustomEvent('nextTabEvent', param));
                    });

                    this.$.clearBtn.addEventListener('click', function () {
                        _this.$.inputStudyDesc.value = "";
                        _this.$.inputShortcut.value = "";
                    });
                }

                searchStudyDesc(){
                    let input = _this.$.inputStudyDesc.value;
                    let inputStudyDesc = g_humiicDesc;
                    let resultStudyDesc = new Array();
                    for(let i=0; i<inputStudyDesc.length; i++){
                        if(inputStudyDesc[i].studyDescription){
                            let descValue = inputStudyDesc[i].studyDescription.toLowerCase();
                            if(descValue.includes(input)){
                                let result = {};
                                result.studyDescription = inputStudyDesc[i].studyDescription;
                                result.hCode  = inputStudyDesc[i].hCode;
                                result.modality = inputStudyDesc[i].modality;
                                resultStudyDesc.push(result);
                            }
                        }
                    }
                    let rowNodes = resultStudyDesc;
                    _this.gridOptions.api.setRowData(rowNodes);
                }

                // readTextFile(file, callback) {
                //     var rawFile = new XMLHttpRequest();
                //     rawFile.overrideMimeType("application/json");
                //     rawFile.open("GET", file, true);
                //     rawFile.onreadystatechange = function() {
                //         if (rawFile.readyState === 4 && rawFile.status == "200") {
                //             callback(rawFile.responseText);
                //         }
                //     }
                //     rawFile.send(null);
                // }

                readTextFile() {
                    let fileReader = new XMLHttpRequest();
                    fileReader.open('GET', '../hh-reading-template/humiic_studyDesc_json', true);
                    fileReader.onload = function(response) {
                        console.log(response);
                        if (fileReader.status == 200) {
                            let properties = JSON.parse(fileReader.responseText);
                            g_humiicDesc = properties;
                            fileReader.close();
                        }
                    };
                    fileReader.send(null);
                }

            }
            window.customElements.define(HhReadingTemplateStudyDesc.is, HhReadingTemplateStudyDesc);
        })();
    </script>
</dom-module>
