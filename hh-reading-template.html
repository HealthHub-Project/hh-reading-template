<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../vaadin-icons/vaadin-icons.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<script src="../ag-grid-enterprise/dist/ag-grid-enterprise.js"></script>
<link rel="import" href="../ag-grid-polymer/ag-grid-polymer.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../iron-selector/iron-selector.html">

<script src="licenseKey.js"></script>
<dom-module id="hh-reading-template">
    <template>
        <link rel="stylesheet" href="../bower_components/ag-grid/dist/styles/ag-grid.css">
        <link rel="stylesheet" href="../bower_components/ag-grid/dist/styles/ag-theme-balham-dark.css">
        <style>
            :host {
                display: block;
                height: 100%;
                width: 100%;
            }

            ag-grid-polymer {
                width: 100%;
                height: 100%;
            }

            .container {
                height: 100%;
                width: 100%;
            }

            .context {
                padding: 5px;
                height: calc(100% - 10px);
                width: calc(100% - 10px);
            }

            .template-configure {
                display: flex;
                height: 75px;
            }

            .template-configure-sensitive {
                width: 100%;
                margin-right: 5%;
            }

            .template-list {
                height: calc(100% - 75px);
            }

            .template-configure-setting-btn {
                width: 100px;
            }

            .class-sensitiveCheck{
                width: 80%;
                font-size: 13px;
                color: #aaaaaa;
            }

            .checkBox-style{
                font-size: 13px;
                color: #aaaaaa;
                --paper-checkbox-checked-color: #0087cb;
                --paper-checkbox-label-color: #aaaaaa;
                --paper-checkbox-unchecked-color: #4c5667;
                padding: 3px;
            }

            .icon-style {
                color: #aaaaaa;
                height: 25px;
                width: 25px;
                padding: 5px;
            }

            paper-toast {
                --paper-toast-color: white;
            }

        </style>
        <div class="container">
            <paper-toast id="toast" duration="1000" class="class-toast"></paper-toast>
            <div class="context">
                <div class="template-configure">
                    <div class="template-configure-sensitive">
                        <div class="class-sensitiveCheck">
                            <iron-selector attr-for-selected="value" id="sensitive" selected-values="{{selectSensitive}}"
                                           multi>
                                <paper-checkbox value="modality" id="sensitiveModal" class="checkBox-style" noink>Modality Sensitive</paper-checkbox>
                                <paper-checkbox value="bodypart" class="checkBox-style" noink>Bodypart Sensitive</paper-checkbox>
                                <paper-checkbox value="studyDescription" class="checkBox-style" noink>Study description Sensitive</paper-checkbox>
                            </iron-selector>
                        </div>
                    </div>
                    <div class="template-configure-setting-btn">
                        <iron-icon icon="vaadin:line-v" style="color: #aaaaaa; height: 15px; width: 15px"></iron-icon>
                        <paper-icon-button id="newTemplateBtn" icon="vaadin:plus-circle" class="icon-style">
                        </paper-icon-button>
                        <paper-icon-button id="settingBtn" icon="vaadin:vaadin:cog" class="icon-style">
                        </paper-icon-button>
                        <iron-icon icon="vaadin:line-v" style="color: #aaaaaa; height: 15px; width: 15px"></iron-icon>
                        <input id="importBtn" type="file" style="display:none" />
                        <paper-icon-button id="iconFileBtn" icon="vaadin:cloud-upload" class="icon-style">
                        </paper-icon-button>
                        <paper-icon-button id="exportBtn" icon="vaadin:cloud-download" class="icon-style">
                        </paper-icon-button>
                    </div>
                </div>
                <div class="template-list">
                    <ag-grid-polymer
                            class="ag-theme-balham-dark"
                            rowData="{{rowData}}" ,
                            columnDefs="{{columnDefs}}"
                            gridOptions="{{gridOptions}}"
                    ></ag-grid-polymer>
                </div>
            </div>
        </div>
    </template>
    <script>
        (function () {
            let _this;
            let g_readingTemplateList = new Array();
            let g_popup;
            let message = new Object();

            class HhReadingTemplate extends Polymer.Element {
                static get is() {
                    return 'hh-reading-template';
                }

                static get properties(){
                    return{
                        selectSensitive:{
                            type: Array
                        }
                    }
                }

                ready() {
                    super.ready();
                    window.addEventListener("beforeunload", function (event) {
                        if (g_popup) {
                            g_popup.close();
                        }
                    });
                    window.addEventListener('message', event => {
                        if(event.data.flag =="rtConfigure"){
                            _this.readingTemplateUpdate(event.data.readingTemplate);
                        }
                    });

                    this.$.sensitive.addEventListener('selected-items-changed',function(){
                        console.log(_this.selectSensitive);
                    })

                    this.$.newTemplateBtn.addEventListener('click', function (event) {
                        let popup = window.open("/bower_components/hh-reading-template/hh-reading-template-configure.html", "popup", "height=777, width=1700,resizable=yes,toolbar=no,status=0,location=no,menubar=no,scrollbars=0,dependent=yes");
                        // g_popup = window.open("/hh-reading-template-configure.html", "popup", "height=777, width=1700, resizable=yes,toolbar=no,status=0,location=no,menubar=no,scrollbars=0,dependent=yes");
                        g_popup.struct = "popup test";
                    })
                    this.$.settingBtn.addEventListener('click', function (event) {
                        console.log("setting");
                    })

                    this.$.iconFileBtn.addEventListener('click',function () {
                        _this.$.importBtn.click();
                    });

                    this.$.importBtn.addEventListener('change', function (event) {
                        if(this.files[0].name.includes("ReadingTemplate")){
                            _this.importRedingTemplateToJson(this.files);
                            this.files = null;
                        }else{
                            message.isErr = true;
                            message.text = "Please select file which is the name of exportReadingTemplate.";
                            _this.openToast(message);
                        }

                    })
                    this.$.exportBtn.addEventListener('click', function (event) {
                        _this.exportRedingTemplateToJson();
                    })
                }

                constructor() {
                    super();
                    _this = this;

                    this.gridOptions = {
                        defaultColDef: {
                            suppressMenu: true // 메뉴 막기
                        },
                        enableSorting: true,
                        enableColResize: true,
                        rowSelection: "single",
                        overlayNoRowsTemplate: '<span class="ag-overlay-no-rows-center">No records Found</span>',
                        toolPanelSuppressSideButtons: true,
                        toolPanelSuppressRowGroups: true,
                        toolPanelSuppressValues: true,
                        toolPanelSuppressColumnSelectAll: true,
                        toolPanelSuppressColumnExpandAll: true,
                        toolPanelSuppressColumnFilter: true,
                        toolPanelSuppressPivots: true,
                        toolPanelSuppressPivotMode: true,
                        components: {
                            agDateInput: CustomDateComponent
                        }
                    };

                    this.columnDefs = [
                        {headerName: "Title", field: "title", width: 100},
                        {headerName: "Shortcut", field: "shortcut", width: 90},
                        {headerName: "Modality", field: "modality", width: 100},
                        {headerName: "Bodypart", field: "bodypart", width: 100},
                        {headerName: "Study description", field: "studyDescription", width: 100},
                        {headerName: "Finding", field: "finding"},
                        {headerName: "Conclusion", field: "conclusion"},
                        {headerName: "Recommendation", field: "recommendation"}
                    ];
                    this.rowData = [
                        // {seqNo:"0", title: "TEST", shortcut: "TEST SHORTCUT", modality: "CT, MR", bodypart: "CHEST, FOOT", studyDescription: "TEST STUDY DESCRIPTION", finding: "FINDING", conclusion: "CONCLUSION", recommendation: "RECOMMENDATION"},
                    ];


                    this.gridOptions.onGridReady = (params) => {
                        // params.api.sizeColumnsToFit();
                    }

                    this.gridOptions.onRowSelected = (e) => {
                    };

                    this.gridOptions.onRowDoubleClicked = (event) => {
                        let struct = event.data;
                        if(!g_popup.closed){
                            g_popup.struct = struct;
                        }else{
                            g_popup  = window.open("/bower_components/hh-reading-template/hh-reading-template-configure.html", "popup", "height=777, width=1700,resizable=yes,toolbar=no,status=0,location=no,menubar=no,scrollbars=0,dependent=yes");
                            // g_popup = window.open("/hh-reading-template-configure.html", "popup", "height=777, width=1700, resizable=yes,toolbar=no,status=0,location=no,menubar=no,scrollbars=0,dependent=yes");
                        }
                    }
                }

                getReadingTemplateList(readingTemplateList){
                    if(readingTemplateList){
                        for(let i=0; i<readingTemplateList.length; i++){
                            g_readingTemplateList[i].push(readingTemplateList[i]);
                        }
                    }
                }

                readingTemplateUpdate(rtConfigure){
                    g_readingTemplateList.push(rtConfigure);
                    _this.gridOptions.api.setRowData(g_readingTemplateList);
                }

                exportRedingTemplateToJson(){
                    if(g_readingTemplateList.length>0){
                        _this.writeJsonFile(g_readingTemplateList);
                    }else{
                        message.isErr = true;
                        message.text = "No reading template.";
                        _this.openToast(message);
                    }
                }

                /**
                 * Import ReadingTemplate from Json
                 *
                 * Create by BohyunJang on 2019-01-24 오후 12:30
                **/
                importRedingTemplateToJson(readFile) {
                    let reader = new FileReader();
                    reader.readAsText(readFile[0]);
                    reader.onload = function(){
                        let result = JSON.parse(reader.result);
                        let cnt =0;
                        for(let i=0; i<result.length; i++){
                            g_readingTemplateList.push(result[i]);
                            cnt ++;
                            if(cnt == result.length){
                                // console.log(g_readingTemplateList);
                                //TODO : 파일 업로드 이후 디비 업데이트
                                _this.gridOptions.api.setRowData(g_readingTemplateList);
                            }
                        }
                    }
                }

                /**
                 * Export ReadingTemlate to Josn
                 *
                 * Create by BohyunJang on 2019-01-24 오후 12:33
                **/
                writeJsonFile(readingTemplateList){
                    let contents =JSON.stringify(readingTemplateList);
                    this.saveToFile_Chrome("ReadingTemplate",contents);
                }

                saveToFile_Chrome(fileName, content) {
                    let blob = new Blob([content], { type: 'text/plain' });
                    let objURL = window.URL.createObjectURL(blob);

                    if (window.__Xr_objURL_forCreatingFile__) {
                        window.URL.revokeObjectURL(window.__Xr_objURL_forCreatingFile__);
                    }
                    window.__Xr_objURL_forCreatingFile__ = objURL;

                    let a = document.createElement('a');
                    a.download = fileName;
                    a.href = objURL;
                    a.click();
                }

                openToast(message){
                    if (!message.isErr) {
                        _this.$.toast.style.backgroundColor = "#0087cb";
                    } else {
                        _this.$.toast.style.backgroundColor = "#e46159";
                    }
                    this.$.toast.text = message.text;
                    this.$.toast.open();
                    if(message.isErr){
                        return false;
                    }
                }

            }

            window.customElements.define(HhReadingTemplate.is, HhReadingTemplate);
        })();
    </script>
</dom-module>
