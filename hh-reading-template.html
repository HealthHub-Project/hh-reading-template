<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../vaadin-icons/vaadin-icons.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<script src="../ag-grid-enterprise/dist/ag-grid-enterprise.js"></script>
<link rel="import" href="../ag-grid-polymer/ag-grid-polymer.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../iron-selector/iron-selector.html">

<script src="licenseKey.js"></script>
<dom-module id="hh-reading-template">
    <template>
        <link rel="stylesheet" href="../bower_components/ag-grid/dist/styles/ag-grid.css">
        <link rel="stylesheet" href="../bower_components/ag-grid/dist/styles/ag-theme-balham-dark.css">
        <style>
            :host {
                display: block;
                height: 100%;
                width: 100%;
            }

            ag-grid-polymer {
                width: 100%;
                height: 100%;
                color: #aaaaaa !important;
                font-size: 12px !important;
                font-weight: normal !important;
                background-color: #2d333f !important;
                font-family: "NotoSansCJKLight" !important;
            }

            .ag-header {
                background-color: #2d333f !important;
                color: #cccccc !important;
                border-bottom: 3px solid #0087cb !important;
                font-weight: bold !important;
                font-size: 12px !important;
            }

            .ag-row {
                border-bottom: 1px solid #414a59 !important;
            }

            .ag-row-even {
                background-color: rgba(76, 86, 103, 0.2) !important;
            }

            .ag-row-odd {
                background-color: #2d333f !important;
            }

            .ag-row-selected {
                background-color: #596072 !important;
                color: #fff !important;
            }

            .ag-cell-focus {
                border: 1px solid darkgrey !important;
            }

            .container {
                height: 100%;
                width: 100%;
            }

            .context {
                padding: 5px;
                height: calc(100% - 10px);
                width: calc(100% - 10px);
            }

            .template-configure {
                display: flex;
                height: 75px;
            }

            .template-configure-sensitive {
                width: 100%;
                margin-right: 5%;
            }

            .template-list {
                height: calc(100% - 75px);
            }

            .template-configure-setting-btn {
                width: 110px;
            }

            .class-sensitiveCheck{
                width: 80%;
                font-size: 13px;
                color: #aaaaaa;
            }

            .checkBox-style{
                font-size: 13px;
                color: #aaaaaa;
                --paper-checkbox-checked-color: #0087cb;
                --paper-checkbox-label-color: #aaaaaa;
                --paper-checkbox-unchecked-color: #4c5667;
                padding: 3px;
            }

            .icon-style {
                color: #aaaaaa;
                height: 25px;
                width: 25px;
                padding: 5px;
            }

            paper-toast {
                --paper-toast-color: white;
            }

        </style>
        <div class="container">
            <paper-toast id="toast" duration="1000" class="class-toast"></paper-toast>
            <div class="context">
                <div class="template-configure">
                    <div class="template-configure-sensitive">
                        <div class="class-sensitiveCheck">
                            <iron-selector attr-for-selected="value" id="sensitive" selected-values="{{selectSensitive}}"
                                           multi>
                                <paper-checkbox value="modality" id="modalitySensitive" class="checkBox-style" noink>Modality Sensitive</paper-checkbox>
                                <paper-checkbox value="bodypart" id="bodypartSensitive" class="checkBox-style" noink>Bodypart Sensitive</paper-checkbox>
                                <paper-checkbox value="studyDescription" id="studyDescSensitive" class="checkBox-style" noink>Study description Sensitive</paper-checkbox>
                            </iron-selector>
                        </div>
                    </div>
                    <div class="template-configure-setting-btn">
                        <iron-icon icon="vaadin:line-v" style="color: #aaaaaa; height: 15px; width: 15px"></iron-icon>
                        <paper-icon-button id="newTemplateBtn" icon="vaadin:plus-circle" class="icon-style">
                        </paper-icon-button>
                        <paper-icon-button id="settingBtn" icon="vaadin:vaadin:cog" class="icon-style">
                        </paper-icon-button>
                        <iron-icon icon="vaadin:line-v" style="color: #aaaaaa; height: 15px; width: 15px"></iron-icon>
                        <input id="importBtn" type="file" style="display:none" />
                        <paper-icon-button id="iconFileBtn" icon="vaadin:cloud-upload" class="icon-style">
                        </paper-icon-button>
                        <paper-icon-button id="exportBtn" icon="vaadin:cloud-download" class="icon-style">
                        </paper-icon-button>
                    </div>
                </div>
                <div class="template-list">
                    <ag-grid-polymer
                            class="ag-theme-balham-dark"
                            rowData="{{rowData}}" ,
                            columnDefs="{{columnDefs}}"
                            gridOptions="{{gridOptions}}"
                    ></ag-grid-polymer>
                </div>
            </div>
        </div>
    </template>
    <script>
        (function () {
            let _this;
            let g_SelectedRow = new Object();
            let g_readingTemplateList = new Array();
            let g_sortedTemplateList = new Array();
            let g_tempSensitiveTemplateList = new Array();
            let g_popup = new Object();
            let message = new Object();

            class HhReadingTemplate extends Polymer.Element {
                static get is() {
                    return 'hh-reading-template';
                }

                static get properties(){
                    return{
                        selectSensitive:{
                            type: Array
                        }
                    }
                }

                ready() {
                    super.ready();
                    window.addEventListener("beforeunload", function (event) {
                        // if (g_popup.window) {
                        //     g_popup.close();
                        // }
                    });
                    window.addEventListener('message', event => {
                        if(event.data.flag =="rtSaveEvent"){
                            _this.saveReadingTemplate(event.data.readingTemplate);
                        }else if(event.data.flag =="rtUpdateEvent"){
                            console.log(event.data);
                            _this.updateReadingTemplate(event.data.readingTemplate);
                        }
                    });

                    this.$.sensitive.addEventListener('selected-items-changed',function(e){
                        let sensitiveArray = new Array();
                        let cnt0 = 0;

                        if(e.detail.value.length > 0){
                            for(let i=0; i<e.detail.value.length; i++){
                                if(e.detail.value[i].value =="modality"){
                                    sensitiveArray.push("modality");
                                }
                                if(e.detail.value[i].value =="bodypart"){
                                    sensitiveArray.push("bodypart");
                                }
                                if(e.detail.value[i].value == "studyDescription"){
                                    sensitiveArray.push("studyDescriptiont");
                                }

                                cnt0++;
                                if(cnt0 == e.detail.value.length){
                                    if(Boolean(g_SelectedRow.id && sensitiveArray.length > 0)){
                                        let cnt1 = 0;
                                        for(let i=0 ;i<sensitiveArray.length; i++){
                                            if(sensitiveArray[i].includes("modality")){
                                                for(let j=0; j<g_readingTemplateList.length; j++){
                                                    let modalityArr = new Array();
                                                    modalityArr = g_readingTemplateList[j].modality;
                                                    if(modalityArr.length > 0){
                                                        for(let k=0; k<modalityArr.length; k++){
                                                            for(let l = 0; l<modalityArr[k].length; l++){
                                                                if(modalityArr[k][l] === g_SelectedRow.modality){
                                                                    g_sortedTemplateList.push(g_readingTemplateList[j]);
                                                                    if(!g_tempSensitiveTemplateList){
                                                                        g_tempSensitiveTemplateList.push(g_readingTemplateList[j]);
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }else{
                                                        g_sortedTemplateList = new Array();
                                                    }
                                                }
                                            }

                                            if(sensitiveArray[i].includes("bodypart")){
                                                for(let j=0; j<g_readingTemplateList.length; j++){
                                                    let bodypartArr = new Array();
                                                    bodypartArr  = g_readingTemplateList[j].bodypart;
                                                    if(bodypartArr.length > 0){
                                                        for(let k=0; k<bodypartArr.length; k++){
                                                            for(let l=0; l<bodypartArr[k].length; l++){
                                                                if(typeof(bodypartArr[k]) != "number" && bodypartArr[k][j] === g_SelectedRow.bodypart){
                                                                    g_sortedTemplateList.push(g_readingTemplateList[j]);
                                                                    if(!g_tempSensitiveTemplateList){
                                                                        g_tempSensitiveTemplateList.push(g_readingTemplateList[j]);
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }else{
                                                        g_sortedTemplateList = new Array();
                                                    }
                                                }
                                            }

                                            if(sensitiveArray[i].includes("studyDescription")){
                                                for(let j=0; j<g_readingTemplateList.length; j++){
                                                    if(g_readingTemplateList[j].studyDescription.includes( g_SelectedRow.studyDescription)){
                                                        g_sortedTemplateList.push(g_readingTemplateList[j]);
                                                        if(!g_tempSensitiveTemplateList){
                                                            g_tempSensitiveTemplateList.push(g_readingTemplateList[j]);
                                                        }
                                                    }else{
                                                        g_sortedTemplateList = new Array();
                                                    }
                                                }
                                            }

                                            cnt1++;
                                            if(cnt1 == sensitiveArray.length){;
                                                e.target.__dataHost.gridOptions.api.setRowData(g_sortedTemplateList);
                                                g_sortedTemplateList = new Array();
                                            }
                                        }
                                    }else{
                                        e.target.__dataHost.gridOptions.api.setRowData(g_readingTemplateList);
                                    }
                                }
                            }
                        }else{
                            g_tempSensitiveTemplateList = new Array();
                            e.target.__dataHost.gridOptions.api.setRowData(g_readingTemplateList);
                        }
                    });

                    this.$.newTemplateBtn.addEventListener('click', function (event) {
                        let g_popup = window.open("/bower_components/hh-reading-template/hh-reading-template-configure.html", "popup", "height=777, width=1700,resizable=yes,toolbar=no,status=0,location=no,menubar=no,scrollbars=0,dependent=yes");
                        // g_popup = window.open("/hh-reading-template-configure.html", "popup", "height=777, width=1700, resizable=yes,toolbar=no,status=0,location=no,menubar=no,scrollbars=0,dependent=yes");
                        if(g_readingTemplateList){
                            let param = new Object
                            let data = new Object;
                            data.g_readingTemplateList = g_readingTemplateList;
                            param.data = data;
                            let struct = param.data;
                            g_popup.struct = struct;
                        }
                        g_popup.focus();
                    })
                    this.$.settingBtn.addEventListener('click', function (event) {
                        console.log("setting");
                    })

                    this.$.iconFileBtn.addEventListener('click',function () {
                        _this.$.importBtn.click();
                    });

                    this.$.importBtn.addEventListener('change', function (event) {
                        if(this.files[0].name.includes("ReadingTemplate") && this.files[0].type == "text/plain"){
                            this.importRedingTemplateToJson(this.files);
                            event.target.value = "";
                        }else{
                            event.target.value = "";
                            message.isErr = true;
                            message.text = "Please select file which is the name of exportReadingTemplate.";
                            _this.openToast(message);
                        }

                    })
                    this.$.exportBtn.addEventListener('click', function (event) {
                        _this.exportRedingTemplateToJson();
                    })
                }

                constructor() {
                    super();
                    _this = this;

                    this.gridOptions = {
                        defaultColDef: {
                            suppressMenu: true // 메뉴 막기
                        },
                        enableSorting: true,
                        enableColResize: true,
                        rowSelection: "single",
                        overlayNoRowsTemplate: '<span class="ag-overlay-no-rows-center">No records Found</span>',
                        toolPanelSuppressSideButtons: true,
                        toolPanelSuppressRowGroups: true,
                        toolPanelSuppressValues: true,
                        toolPanelSuppressColumnSelectAll: true,
                        toolPanelSuppressColumnExpandAll: true,
                        toolPanelSuppressColumnFilter: true,
                        toolPanelSuppressPivots: true,
                        toolPanelSuppressPivotMode: true
                    };

                    this.columnDefs = [
                        {headerName: "Title", field: "title", width: 100},
                        {headerName: "Shortcut", field: "shortcut", width: 90},
                        {headerName: "Modality", field: "modality", width: 100},
                        {headerName: "Bodypart", field: "bodypart", width: 100},
                        {headerName: "Study description", field: "studyDescription", width: 100},
                        {headerName: "Finding", field: "finding"},
                        {headerName: "Conclusion", field: "conclusion"},
                        {headerName: "Recommendation", field: "recommendation"}
                    ];
                    this.rowData = [
                        // {seqNo:"0", title: "TEST", shortcut: "TEST SHORTCUT", modality: "CT, MR", bodypart: "CHEST, FOOT", studyDescription: "TEST STUDY DESCRIPTION", finding: "FINDING", conclusion: "CONCLUSION", recommendation: "RECOMMENDATION"},
                    ];


                    this.gridOptions.onGridReady = (params) => {
                        // params.api.sizeColumnsToFit();
                    };

                    this.gridOptions.getContextMenuItems = (params) => {
                        let result = [
                            {
                                name: 'delete',
                                action: function () {
                                    _this.deleteReadingTemplate(params.node.data);
                                }
                            }
                        ];
                        return result;
                    }

                    this.gridOptions.onRowSelected = (e) => {
                    };

                    this.gridOptions.onRowDoubleClicked = (event) => {
                        console.log(event.data);
                        if(g_readingTemplateList.length>0){
                            let data = event.data;
                            data.g_readingTemplateList = g_readingTemplateList;
                            event.data = data;
                        }
                        let struct = event.data;
                        if(g_popup.window == null){

                            g_popup  = window.open("/bower_components/hh-reading-template/hh-reading-template-configure.html", "popup", "height=777, width=1700,resizable=yes,toolbar=no,status=0,location=no,menubar=no,scrollbars=0,dependent=yes");
                            // g_popup = window.open("/hh-reading-template-configure.html", "popup", "height=777, width=1700, resizable=yes,toolbar=no,status=0,location=no,menubar=no,scrollbars=0,dependent=yes");
                            g_popup.struct = struct;
                            g_popup.focus();
                        }else{
                            if(!g_popup.window.closed){
                                g_popup.close();
                                g_popup  = window.open("/bower_components/hh-reading-template/hh-reading-template-configure.html", "popup", "height=777, width=1700,resizable=yes,toolbar=no,status=0,location=no,menubar=no,scrollbars=0,dependent=yes");
                                // g_popup = window.open("/hh-reading-template-configure.html", "popup", "height=777, width=1700, resizable=yes,toolbar=no,status=0,location=no,menubar=no,scrollbars=0,dependent=yes");
                                g_popup.struct = struct;
                                g_popup.focus();
                                // g_popup.reload();
                            }else{
                                g_popup  = window.open("/bower_components/hh-reading-template/hh-reading-template-configure.html", "popup", "height=777, width=1700,resizable=yes,toolbar=no,status=0,location=no,menubar=no,scrollbars=0,dependent=yes");
                                // g_popup = window.open("/hh-reading-template-configure.html", "popup", "height=777, width=1700, resizable=yes,toolbar=no,status=0,location=no,menubar=no,scrollbars=0,dependent=yes");
                                g_popup.struct = struct;
                                g_popup.focus();
                            }
                        }
                    }
                }

                setSensitiveCheckedDefault(){
                    let cnt = 0;
                    this.selectSensitive = new Array();
                    for(let i=0; i<this.$.sensitive.childElementCount; i++){
                        this.$.sensitive.children[i].checked = false;
                        cnt++;
                        if(cnt == this.$.sensitive.childElementCount && (g_readingTemplateList.length > 0)){
                            _this.gridOptions.api.setRowData(g_readingTemplateList);
                        }
                    }
                }

                setSensitiveChectedExpand(param){
                    let sensitiveArr= param;
                    if(sensitiveArr.length > 0) {
                        this.selectSensitive = new Array();
                        if (sensitiveArr.includes('modality')) {
                            this.$.modalitySensitive.checked = true;
                            this.selectSensitive.push("modality");
                        }else if(!sensitiveArr.includes('modality') && this.$.modalitySensitive.checked){
                            this.$.modalitySensitive.checked = false;
                            this.selectSensitive.pop("modality");
                        }
                        if (sensitiveArr.includes('bodypart')) {
                            this.$.bodypartSensitive.checked = true;
                            this.selectSensitive.push("bodypart");
                        }else if(!sensitiveArr.includes('bodypart') && this.$.bodypartSensitive.checked){
                            this.$.bodypartSensitive.checked = false;
                            this.selectSensitive.pop("bodypart");
                        }
                        if (sensitiveArr.includes('studyDescription')) {
                            this.$.studyDescSensitive.checked = true;
                            this.selectSensitive.push("studyDescription");
                        }else if(!sensitiveArr.includes('studyDescription') && this.$.studyDescSensitive.checked){
                            this.$.studyDescSensitive.checked = false;
                            this.selectSensitive.pop("studyDescription");
                        }
                    }else {
                        if(this.$.modalitySensitive.checked){
                            this.$.modalitySensitive.checked = false;
                            this.selectSensitive.pop("modality");
                        }
                        if(this.$.bodypartSensitive.checked){
                            this.$.bodypartSensitive.checked = false;
                            this.selectSensitive.pop("bodypart");
                        }
                        if(this.$.studyDescSensitive.checked){
                            this.$.studyDescSensitive.checked = false;
                            this.selectSensitive.pop("studyDescription");
                        }
                    }
                }


                getReadingTemplateList(params){
                    if(params.readingTemplateList && !params.selectedRow){
                        let cnt =0;
                        let readingTemplateList = params.readingTemplateList;
                        g_readingTemplateList = new Array();
                        for(let i=0; i<readingTemplateList.length; i++){
                            g_readingTemplateList.push(readingTemplateList[i]);
                            cnt++;
                            if(cnt == readingTemplateList.length){
                                this.gridOptions.api.setRowData(g_readingTemplateList);
                            }
                        }
                    }else if(params){
                        g_SelectedRow = params.selectedRow;
                    }
                }

                deleteReadingTemplate(data){
                    console.log("delete");
                    // console.log(data);
                    g_readingTemplateList.pop(data.seqNo);
                    _this.gridOptions.api.setRowData(g_readingTemplateList);
                    let param = new Object();
                    let detail = new Object();
                    detail.readingTemplate= data;
                    param.detail = detail;
                    this.dispatchEvent(new CustomEvent('deleteReadingTemplateEvent', param));
                }

                saveReadingTemplate(readingTemplate){
                    if(g_readingTemplateList.length > 0){
                        readingTemplate.seqNo = g_readingTemplateList.length + 1;
                    }else{
                        readingTemplate.seqNo = 1;
                    }
                    readingTemplate.hotkey1 = "";
                    readingTemplate.hotkey2 = "";

                    g_readingTemplateList.push(readingTemplate);
                    _this.gridOptions.api.setRowData(g_readingTemplateList);

                    let param = new Object();
                    let detail = new Object();
                    detail.readingTemplate = readingTemplate;
                    param.detail = detail;
                    _this.dispatchEvent(new CustomEvent('saveReadingTemplateEvent', param));
                }

                updateReadingTemplate(readingTemplate){
                    console.log("update");
                    for(let i=0; i<g_readingTemplateList.length; i++){
                        console.log(i);
                        if(g_readingTemplateList[i].seqNo == readingTemplate.seqNo){
                            if(readingTemplate.modality){
                                g_readingTemplateList[i].modality = readingTemplate.modality;
                            }
                            if(readingTemplate.bodypart){
                                g_readingTemplateList[i].bodypart = readingTemplate.bodypart;
                            }
                            if(readingTemplate.studyDescription){
                                g_readingTemplateList[i].studyDescription = readingTemplate.studyDescription;
                            }
                            if(readingTemplate.title){
                                g_readingTemplateList[i].title = readingTemplate.title;
                            }
                            if(readingTemplate.finding){
                                g_readingTemplateList[i].finding = readingTemplate.finding;
                            }
                            if(readingTemplate.conclusion){
                                g_readingTemplateList[i].conclusion = readingTemplate.conclusion;
                            }
                            if(readingTemplate.recommendation){
                                g_readingTemplateList[i].recommendation = readingTemplate.recommendation;
                            }
                            _this.gridOptions.api.setRowData(g_readingTemplateList);
                            let param = new Object();
                            let detail = new Object();
                            detail.readingTemplate = g_readingTemplateList[i];
                            param.detail = detail;
                            _this.dispatchEvent(new CustomEvent('updateReadingTemplateEvent', param));
                        }
                    }
                }

                exportRedingTemplateToJson(){
                    if(g_readingTemplateList.length>0){
                        _this.writeJsonFile(g_readingTemplateList);
                    }else{
                        message.isErr = true;
                        message.text = "No reading template.";
                        _this.openToast(message);
                    }
                }

                /**
                 * Import ReadingTemplate from Json
                 *
                 * Create by BohyunJang on 2019-01-24 오후 12:30
                 **/
                importRedingTemplateToJson(readFile) {
                    let reader = new FileReader();
                    reader.readAsText(readFile[0]);
                    reader.onload = function(){
                        let result = JSON.parse(reader.result);
                        let cnt =0;
                        for(let i=0; i<result.length; i++){
                            g_readingTemplateList.push(result[i]);
                            cnt ++;
                            if(cnt == result.length){
                                let cnt2 = 0;
                                for(let j=0; j<g_readingTemplateList.length; j++) {
                                    g_readingTemplateList[j].seqNo = j+1;
                                    let param = new Object();
                                    let detail = new Object();
                                    detail.readingTemplate = g_readingTemplateList[j];
                                    param.detail = detail;
                                    _this.dispatchEvent(new CustomEvent('saveReadingTemplateEvent', param));
                                    cnt2++;
                                    if (cnt2 == g_readingTemplateList.length) {
                                        _this.gridOptions.api.setRowData(g_readingTemplateList);
                                    }
                                }
                            }
                        }
                    }
                }

                /**
                 * Export ReadingTemlate to Josn
                 *
                 * Create by BohyunJang on 2019-01-24 오후 12:33
                 **/
                writeJsonFile(readingTemplateList){
                    let contents =JSON.stringify(readingTemplateList);
                    this.saveToFile_Chrome("ReadingTemplate",contents);
                }

                saveToFile_Chrome(fileName, content) {
                    let blob = new Blob([content], { type: 'text/plain' });
                    let objURL = window.URL.createObjectURL(blob);
                    if (window.__Xr_objURL_forCreatingFile__) {
                        window.URL.revokeObjectURL(window.__Xr_objURL_forCreatingFile__);
                    }
                    window.__Xr_objURL_forCreatingFile__ = objURL;
                    let a = document.createElement('a');
                    a.download = fileName;
                    a.href = objURL;
                    a.click();
                }

                openToast(message){
                    if (!message.isErr) {
                        _this.$.toast.style.backgroundColor = "#0087cb";
                    } else {
                        _this.$.toast.style.backgroundColor = "#e46159";
                    }
                    this.$.toast.text = message.text;
                    this.$.toast.open();
                    if(message.isErr){
                        return false;
                    }
                }

            }

            window.customElements.define(HhReadingTemplate.is, HhReadingTemplate);
        })();
    </script>
</dom-module>
