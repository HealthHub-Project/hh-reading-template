<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>hh-reading-template configure</title>
</head>

<!--bower component-->
<link rel="import" href="../shadycss/apply-shim.html">
<link rel="import" href="../polymer/lib/elements/custom-style.html">
<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../iron-autogrow-textarea/iron-autogrow-textarea.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../iron-selector/iron-selector.html">
<link rel="import" href="../paper-input/paper-input.html">

<!--develop-->
<!--<link rel="import" href="./bower_components/shadycss/apply-shim.html">-->
<!--<link rel="import" href="./bower_components/polymer/lib/elements/custom-style.html">-->
<!--<link rel="import" href="./bower_components/polymer/polymer-element.html">-->
<!--<link rel="import" href="./bower_components/paper-icon-button/paper-icon-button.html">-->
<!--<link rel="import" href="./bower_components/iron-autogrow-textarea/iron-autogrow-textarea.html">-->
<!--<link rel="import" href="./bower_components/paper-tabs/paper-tabs.html">-->
<!--<link rel="import" href="./bower_components/iron-pages/iron-pages.html">-->
<!--<link rel="import" href="./bower_components/paper-toast/paper-toast.html">-->
<!--<link rel="import" href="./bower_components/paper-checkbox/paper-checkbox.html">-->
<!--<link rel="import" href="./bower_components/iron-selector/iron-selector.html">-->
<!--<link rel="import" href="./bower_components/paper-input/paper-input.html">-->

<link rel="import" href="hh-reading-template-modality.html">
<link rel="import" href="hh-reading-template-bodypart.html">
<link rel="import" href="hh-reading-template-studydesc.html">
<link rel="import" href="hh-reading-template-report.html">
<custom-style>
    <style is="custom-style">
        paper-tabs {
            --paper-tabs-selection-bar: {
                border-bottom: 3px solid #0087cb;
                color: #2baab1;
            };
            --paper-tabs-content: {
                font-weight: bold;
                color: #aaaaaa;
                background-color: #252934;
                font-size: 13px;

            };
            box-shadow: 0px 3px 9px -2px #000000;
            height: 40px;
        }

        paper-tabs paper-tab.iron-selected {
            color: #2baab1;
        }
    </style>
</custom-style>
<style>
    html, body {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
        position: fixed
    }

    .container {
        height: 100%;
        width: 100%;
        background-color: #35363d;
    }

    .class-paper-tabs {
        height: 40px;
        width: 100%;
    }

    .class-ironPage {
        height: calc(100% - 80px);
        width: 100%;
    }

    .class-btn {
        height: 40px;
        width: 100%;
        text-align: center;
        background-color: #14171c;
    }

    .btn {
        width: 100px;
        height: 30px;
        border: 0;
        font-size: 10pt;
        color: #fff;
        cursor: pointer;
        border-radius: 2px;
        margin: 5px;
    }

    .class-tabPage {
        height: 100%;
        width: 100%;
    }

    #saveBtn {
        background: #0087cb;
    }

    #clearBtn {
        background: #4c5667;
    }

    #prevBtn {
        background: #ff646b;
    }

    #nextBtn {
        background: #4c7d35;
    }

    #closeBtn {
        background: #4c5667;
    }

    iron-pages {
        height: 633px;
        background-color: white;
        width: 100%;
    }

    iron-pages div {
        height: 100%;
        width: 100%;
    }

    setting-btnGroups {
        display: flex;
        flex-direction: row;
        flex: 1;
        text-align: center;
        padding: 15px;
    }

    paper-toast {
        --paper-toast-color: white;
    }

    #toast {
        --paper-toast-background-color: #0087cb;
    }

</style>
<body style="background-color: deepskyblue">
<div class="container">
    <paper-toast id="saveToast" duration="1000" class="save-toast"></paper-toast>
    <div class="class-paper-tabs">
        <paper-tabs id="reportTempalteConfigTab" selected="0" noink>
            <paper-tab id="modalityTab" value="modalityTab">Modality</paper-tab>
            <paper-tab id="bodypartTab" value="bodypartTab" disabled>Bodypart</paper-tab>
            <paper-tab id="studyDescTab" value="studyDescriptionTab" disabled>Study Description & Shortcut</paper-tab>
            <paper-tab id="reportTab" value="reportTemplateTab" disabled>Report Template</paper-tab>
        </paper-tabs>
    </div>
    <div class="class-ironPage">
        <iron-pages id="tabPage" class="class-tabPage" selected="0">
            <div>
                <hh-reading-template-modality id="modalityTemplate"></hh-reading-template-modality>
            </div>
            <div>
                <hh-reading-template-badypart id="bodypartTemplate"></hh-reading-template-badypart>
            </div>
            <div>
                <hh-reading-template-studydesc id="studyDescTemplate"></hh-reading-template-studydesc>
            </div>
            <div>
                <hh-reading-template-report id="reportTemplate"></hh-reading-template-report>
            </div>
        </iron-pages>
    </div>
    <div class="class-btn">
        <button id="closeBtn" class="btn">Close</button>
    </div>
</div>
</body>
<script>
    let g_readingTemplate = new Object();
    // let _url = "http://127.0.0.1:8081";
    // let _url = "http://localhost:8081";
    let _url = "hpacsweb.com:8081";

    document.addEventListener("DOMContentLoaded", () => {

        if(window.struct){
            if(window.struct.facilitySensitive){
                let param = new Object();
                param.modalityList = window.struct.facilitySensitive.modalityList;
                param.bodypartList = window.struct.facilitySensitive.bodypartList;
                param.category = "nomal";
                // param.category = "radrex";
                document.getElementById('modalityTemplate').getOtherModalityList(param);
                document.getElementById('bodypartTemplate').getOtherBodypartList(param);
            }
            setReadingTemplate(window.struct);
        }

        document.getElementById("closeBtn").addEventListener('click', function () {
            window.close();
        });

        document.getElementById("reportTempalteConfigTab").addEventListener('selected-changed', function (e) {
            let pageIndex = e.detail.value;
            document.getElementById("tabPage").selectIndex(pageIndex);
        });

        document.getElementById("tabPage").addEventListener('selected-changed', function (e) {
            let tabIndex = e.detail.value;
            document.getElementById("reportTempalteConfigTab").selectIndex(tabIndex);
        });

        document.getElementById('modalityTemplate').addEventListener('activeTab', function (e) {
            if(e.detail.nextBtn == true){
                let modality = e.detail.modality;
                let category = e.detail.category;
                g_readingTemplate.modality = modality;
                g_readingTemplate.category = category;
                document.getElementById('bodypartTab').disabled = false;
            }else{
                document.getElementById('bodypartTab').disabled = true;
            }
        });

        document.getElementById('bodypartTemplate').addEventListener('activeTab', function (e) {
            if(e.detail.nextBtn == true){
                let bodypart = e.detail.bodypart;
                g_readingTemplate.bodypart = bodypart;
                document.getElementById('studyDescTab').disabled = false;
                document.getElementById('reportTab').disabled = false;
            }else{
                document.getElementById('studyDescTab').disabled = true;
                document.getElementById('reportTab').disabled = true;
            }
        });

        document.getElementById('studyDescTemplate').addEventListener('activeTab', function (e) {
            if(e.detail.studyDesc && e.detail.shortcut){
                g_readingTemplate.studyDescription = e.detail.studyDesc;
                g_readingTemplate.shortcut = e.detail.shortcut;
            }else {
                if(e.detail.studyDesc){
                    g_readingTemplate.studyDescription = e.detail.studyDesc;
                }else if(e.detail.shortcut){
                    g_readingTemplate.shortcut = e.detail.shortcut;
                }
            }
        });

        document.getElementById('modalityTemplate').addEventListener('nextTabEvent', function () {
            nextTabEvent();
        });

        document.getElementById('bodypartTemplate').addEventListener('prevTabEvent', function () {
            prevTabEvent();
        });

        document.getElementById('bodypartTemplate').addEventListener('nextTabEvent', function () {
            nextTabEvent();
        });

        document.getElementById('studyDescTemplate').addEventListener('nextTabEvent', function () {
            nextTabEvent();
        });

        document.getElementById('studyDescTemplate').addEventListener('prevTabEvent', function () {
            prevTabEvent();
        });

        document.getElementById('reportTemplate').addEventListener('prevTabEvent', function () {
            prevTabEvent();
        });

        document.getElementById('reportTemplate').addEventListener('saveReportEvent', function (e) {
            g_readingTemplate.title = e.detail.title;
            if(e.detail.finding){g_readingTemplate.finding = e.detail.finding;}
            if(e.detail.conclusion){g_readingTemplate.conclusion = e.detail.conclusion;}
            if(e.detail.recommendation){g_readingTemplate.recommendation = e.detail.recommendation;}
            if(e.detail.seqNo){g_readingTemplate.seqNo = e.detail.seqNo;}
            if(e.detail.displayOrder){g_readingTemplate.displayOrder = e.detail.displayOrder;}
            if(e.detail.hotkey1){g_readingTemplate.hotkey1 = e.detail.hotkey1;}
            if(e.detail.hotkey2){g_readingTemplate.hotkey2 = e.detail.hotkey2;}

            if(e.detail.seqNo){
                reportUpdateEvent();
            }else{
                reportSaveEvent();
            }
        });
    });

    function setReadingTemplate(readingTemplate){
        if(readingTemplate.modality){
            document.getElementById('modalityTemplate').setModality(readingTemplate);
        }
        if(readingTemplate.bodypart){
            document.getElementById('bodypartTemplate').setBodypart(readingTemplate);
        }
        if(readingTemplate.studyDescription){
            document.getElementById('studyDescTemplate').setStudyDesc(readingTemplate);
        }
        if(readingTemplate.title || readingTemplate.finding || readingTemplate.conclusion || readingTemplate.recommendation){
            document.getElementById('reportTemplate').setReport(readingTemplate);
        }
        if(readingTemplate.g_readingTemplateList){
            document.getElementById('reportTemplate').setReadingTemplateList(readingTemplate);
        }
    }

    function reportSaveEvent(){

        /*
        "seqNo" : 1,
        "displayOrder" : 2,
        "title" : "PNS WNL",
        "finding" : "111. Normal paranasal sinuses",
        "conclusion" : "111. Normal paranasal sinuses",
        "recommendation" : "111. Normal paranasal sinuses",
        "modality" : "CR",
        "hotKey1" : "alt",
        "hotKey2" : "1"
        ----------
        bodypart(multi select),
        modality(multi select)
        studyDesc
        * */

        document.getElementById("saveToast").style.backgroundColor = "#0087cb";
        document.getElementById('saveToast').text = "Report save complate.";
        document.getElementById('saveToast').open();
        document.dispatchEvent(new CustomEvent('readingTemplateSaveEvent', g_readingTemplate));
        let param = new Object();
        param.readingTemplate = g_readingTemplate;
        param.flag = "rtSaveEvent";
        opener.window.postMessage(param, _url);
        window.close();
    }

    function reportUpdateEvent(){
        /*
             "seqNo" : 1,
             "displayOrder" : 2,
             "title" : "PNS WNL",
             "finding" : "111. Normal paranasal sinuses",
             "conclusion" : "111. Normal paranasal sinuses",
             "recommendation" : "111. Normal paranasal sinuses",
             "modality" : "CR",
             "hotKey1" : "alt",
             "hotKey2" : "1"
             ----------
             bodypart(multi select),
             modality(multi select)
             studyDesc
             * */

        // console.log(g_readingTemplate);
        // if (!message.isErr) {
        //     document.getElementById("toast2").style.backgroundColor = "#0087cb";
        // } else {
        //     document.getElementById("toast2").style.backgroundColor = "#e46159";
        // }
        document.getElementById("saveToast").style.backgroundColor = "#0087cb";
        document.getElementById('saveToast').text = "Report update complate.";
        document.getElementById('saveToast').open();
        document.dispatchEvent(new CustomEvent('readingTemplateSaveEvent', g_readingTemplate));
        let param = new Object();
        param.readingTemplate = g_readingTemplate;
        param.flag = "rtUpdateEvent";
        opener.window.postMessage(param, _url);
        window.close();
    }

    function nextTabEvent() {
        document.getElementById("tabPage").selectNext();
    }

    function prevTabEvent() {
        document.getElementById("tabPage").selectPrevious();
    }

    function reload(){
        console.log("reload");
        setReadingTemplate(window.struct);
    }

</script>
</html>
